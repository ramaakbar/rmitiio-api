import{b as n,j as s,L as N,e as v,f as C,r as x,S as g,a as b,g as k,u as w,h as P,i as j,k as A,l as h,m as F,c as L,n as S,F as y,o as T}from"./index.182153c5.js";import{u as $}from"./useQuery.esm.bf87a3ed.js";function q({comment:e}){return n("div",{className:"flex flex-row space-x-3 rounded-md bg-grey-50 px-4 py-3 hover:bg-grey-100",children:[s("img",{src:"./placeholder_profile.jpeg",alt:"",className:"h-10 w-10 rounded-full"}),n("div",{className:"flex flex-col space-y-1",children:[n("div",{className:"flex flex-row items-center space-x-1",children:[n(N,{to:`/${e.user.username}`,className:"text-base font-bold text-grey-900 hover:underline",children:["@",e.user.username]}),s("span",{children:"\xB7"}),s("span",{className:"text-sm text-grey-600",children:v(e.createdAt).fromNow()})]}),s("div",{className:"text-grey-900",children:e.content}),s("img",{src:e.picture,alt:e.picture,className:"rounded-md"}),s("div",{children:"Like"})]})]})}function _({comments:e,status:a,fetchNextPage:t,isFetching:i,hasNextPage:r,isFetchingNextPage:l}){var u;const{ref:o,inView:c}=C();return x.exports.useEffect(()=>{c===!0&&t()},[c,t]),a==="loading"?s("div",{className:"flex justify-center",children:s(g,{})}):a==="error"?s("span",{children:"There is an error on fetching posts"}):n("div",{className:"mb-5 mt-5 space-y-5 px-4",children:[(u=e==null?void 0:e.pages)==null?void 0:u.map((m,f)=>s(x.exports.Fragment,{children:m.data.map(p=>s(q,{comment:p},p.id))},f)),s("div",{className:"flex justify-center",children:i?s(g,{}):s("button",{ref:o,onClick:()=>t(),disabled:!r||l})})]})}const B="http://127.0.0.1:4000/api/comments",d=b.create({baseURL:B,withCredentials:!0});d.defaults.headers.common["Content-Type"]="application/json";d.interceptors.response.use(e=>e,async e=>{const a=e.config;if(e.response.data.message.includes("Access Token Expired")&&!a._retry){a._retry=!0;const{accessToken:i}=await k();return localStorage.setItem("accessToken",i),d(a)}return Promise.reject(e)});const E=async({postId:e="",pageParam:a=""})=>(await d.get(`/${e}?cursor=${a}`)).data,Q=async(e="",a,t)=>(await d.post(`/${e}`,a,{headers:{Authorization:`Bearer ${t}`,"Content-Type":"multipart/form-data"}})).data,I=(e,a)=>w({queryKey:["comments",e],queryFn:({pageParam:t})=>E({postId:e,pageParam:t}),getNextPageParam:t=>t.pagination.nextCursor,enabled:!!a}),M=(e,a)=>{const t=P(),i=j(r=>r.logout);return A({mutationFn:r=>Q(e,r,a),onMutate:()=>h.loading("Posting..."),onSuccess:(r,l,o)=>{t.invalidateQueries({queryKey:["comments"]}),h.update(o,{render:"Comment Created",type:"success",isLoading:!1,autoClose:4e3})},onError:(r,l,o)=>{let c;r.response.data.message==="Access Token Expired"?c=`${r.response.data.message}, please refresh the page`:(i(),c=`${r.response.data.message} refresh token and access token expired, please login again`),h.update(o,{render:c,type:"error",isLoading:!1,autoClose:4e3})}})};function K({post:e}){return s("div",{className:"mb-5 space-x-3 border-b px-4 pb-3",children:n("div",{className:"flex flex-col space-y-1",children:[n("div",{className:"flex flex-row items-center space-x-1",children:[s("img",{src:"../../placeholder_profile.jpeg",alt:"",className:"h-10 w-10 rounded-full"}),n(N,{to:`/${e==null?void 0:e.user.username}`,className:"text-base font-bold text-grey-900 hover:underline",children:["@",e==null?void 0:e.user.username]}),s("span",{children:"\xB7"}),s("span",{className:"text-sm text-grey-600",children:v(e==null?void 0:e.user.createdAt).fromNow()})]}),s("div",{className:"text-grey-900",children:e==null?void 0:e.content}),s("img",{src:e.picture,alt:"",className:"rounded-md"}),s("div",{children:"Like"})]})})}const R=e=>$({queryKey:["post",e],queryFn:()=>F(e)});function V(){const{postId:e}=L(),{data:a,status:t}=R(e),{data:i,status:r,fetchNextPage:l,hasNextPage:o,isFetching:c,isFetchingNextPage:u}=I(e,a),{token:m}=S(),f=M(e,m);return n(y,{children:[t==="loading"?s("div",{className:"flex justify-center",children:s(g,{})}):a?n(y,{children:[s(K,{post:a.data}),s(T,{label:"Comment",token:m,mutation:f})]}):s("div",{className:"px-4",children:"Post not found"}),i&&s(_,{comments:i,status:r,fetchNextPage:l,isFetching:c,hasNextPage:o,isFetchingNextPage:u})]})}export{V as default};
